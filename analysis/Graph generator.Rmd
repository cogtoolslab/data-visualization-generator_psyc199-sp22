---
title: "Graph generator"
author: "Man-fang Liang"
date: "4/11/2022"
output:
  html_document: default
---
```{r}
# install.packages("csvy")
library(csvy)
```

# 1. Create synthetic dataset

## Generate numerical variables
```{r echo = FALSE, eval = FALSE}
# numerical variables ------------------------------------------------

# generate variables -------

# generate random mean and sd
# set.seed(1)
mean_vector <- runif(4, min=0, max=100)
# set.seed(2)
sd_vector <- runif(4, min=0, max=100)

rowsize <- 100

# N1 & N2 (independent)
# set.seed(3)
N1 <- rnorm(rowsize, mean=mean_vector[1], sd=sd_vector[1])
# set.seed(4)
N2 <- rnorm(rowsize, mean=mean_vector[2], sd=sd_vector[2])

# N3 & N4 (correlated)
# set.seed(5)
N3 <- rnorm(rowsize, mean=mean_vector[3], sd=sd_vector[3])
# set.seed(6)
N4 <- rnorm(rowsize, mean=mean_vector[4], sd=sd_vector[4])

# make N3 & N4 correlated
N3 <- sort(N3)
N4 <- sort(N4)

# reorder N3 & N4 at the same time
# set.seed(7)
random_order <- sample(1:rowsize, rowsize, replace=F)
N3 <- N3[random_order]
N4 <- N4[random_order]

# add noise to N4
# set.seed(8)
N4 <- N4 + rnorm(rowsize, mean=0, sd=sd_vector[4] * 0.3)


```

## Generate categorical variables
```{r echo = FALSE, eval = FALSE}
# categorical variables ------------------------------------------------

# C1: nominal w/2 values
C1_values <- c('A', 'B')

C1_values_sample <- rep(C1_values, rowsize / length(C1_values))
# set.seed(9)
C1 <- sample(C1_values_sample, rowsize, replace = F)

## Another way of sampling
# C1 <- sample(C1_values, rowsize, replace = T)

# C2: ordernal  w/3 levels, N4 predictive
C2_values <- c('low', 'medium', 'high')

# make N4 predictive of C2
N4_quantile <- quantile(N4, c(0.35, 0.65))
C2 <- ifelse( N4 < N4_quantile[1], C2_values[1], ifelse( N4 < N4_quantile[2], C2_values[2], C2_values[3] ))

# add noise
C2_noise_size <- as.integer(rowsize * 0.3)
# set.seed(10)
C2_noise_index <- sample(1:rowsize, C2_noise_size, replace = F)
# set.seed(11)
C2_noise_value <- sample(C2_values, C2_noise_size, replace = T)

C2[C2_noise_index] <- C2_noise_value

C2 <- factor(C2, levels=c('low', 'medium', 'high'))

```

## Conbine all variables into a single dataset
```{r echo = FALSE, eval = FALSE}
synthetic_df <- data.frame(N1=N1, N2=N2, N3=N3, N4=N4, C1=C1, C2=C2)
synthetic_df

rm(list = c("N1", "N2", "N3", "N4", "C1", "C2"))

```

## Make the sybthetic_df with context
```{r}

rtruncnorm <- function(n, mu, sigma, low, high) {
  # find quantiles that correspond the the given low and high levels.
  p_low <- pnorm(low, mu, sigma)
  p_high <- pnorm(high, mu, sigma)
  
  # draw quantiles uniformly between the limits and pass these
  # to the relevant quantile function.
  qnorm(runif(n, p_low, p_high), mu, sigma)
}

# numerical variables ------------------------------------------------

# generate variables -------

rowsize <- 100

# N1 & N2 (independent)
# N1 is dependent on C1

N2 <- rnorm(rowsize, mean=350, sd=50) # living_expenses

# N3 & N4 (correlated)
N3 <- rnorm(rowsize, mean=100, sd=15) # IQ
N4 <- rtruncnorm(rowsize, 3, 0.45, low = 0, high = 4) # GPA

# make N3 & N4 correlated
N3 <- sort(N3)
N4 <- sort(N4)

# reorder N3 & N4 at the same time
# set.seed(7)
random_order <- sample(1:rowsize, rowsize, replace=F)
N3 <- N3[random_order]
N4 <- N4[random_order]

# add noise to N4
# set.seed(8)
N4 <- N4 + rnorm(rowsize, mean=0, sd=0.45 * 0.4)
# Set limits
minV <- 0; maxV <- 4;
# Limit vector
N4 <- sapply(N4, function(y) min(max(y,minV),maxV))


# categorical variables ------------------------------------------------

# C1: nominal w/2 values
C1_values <- c("Female", "Male")

C1_values_sample <- rep(C1_values, rowsize / length(C1_values))
C1 <- sample(C1_values_sample, rowsize, replace = F)

# N1: dependent on C1
N1_F <- rnorm(rowsize / length(C1_values), mean=21.4, sd=2.76) # bmi
N1_M <- rnorm(rowsize / length(C1_values), mean=24.4, sd=3.19) # bmi
N1 <- rep(0, length(C1))
N1[C1 == "Female"] <- N1_F
N1[C1 == "Male"] <- N1_M

## Another way of sampling
# C1 <- sample(C1_values, rowsize, replace = T)

# C2: ordernal  w/3 levels, N4 predictive
C2_values <- c('low', 'medium', 'high')

# make N4 predictive of C2
N4_quantile <- quantile(N4, c(0.35, 0.65))
C2 <- ifelse( N4 < N4_quantile[1], C2_values[1], ifelse( N4 < N4_quantile[2], C2_values[2], C2_values[3] ))

# add noise
C2_noise_size <- as.integer(rowsize * 0.4)
# set.seed(10)
C2_noise_index <- sample(1:rowsize, C2_noise_size, replace = F)
# set.seed(11)
C2_noise_value <- sample(C2_values, C2_noise_size, replace = T)

C2[C2_noise_index] <- C2_noise_value

C2 <- factor(C2, levels=c('low', 'medium', 'high'))

# rename the variables
synthetic_df <- data.frame(bmi=N1, living_expenses=N2, IQ=N3, GPA=N4, sex=C1, Happiness=C2)


# remove global variables ---------------------------------
rm(list = c("N1", "N2", "N3", "N4", "C1", "C2"))

synthetic_df
```

```{r}
setwd(".")
write_csvy(synthetic_df, file.path(getwd(), "synthetic_df.csv"), row.names = FALSE)

```


## Descriptive statistics for the synthetic dataset
```{r echo = FALSE, eval = FALSE}
summary(synthetic_df)
table(synthetic_df$C1)
table(synthetic_df$C2)

```


# 2. Visualization (Hardcode)
```{r}
# import pacakage
# install.packages("ggplot2",repos = "http://cran.us.r-project.org")
library(ggplot2)
```


### Histogram
```{r echo = FALSE, eval = FALSE}
# histograms for 4 numerical variables

for(i in 1:4){
    print(
        ggplot(synthetic_df) +
            geom_histogram(aes(x = synthetic_df[,i], y = stat(count) / sum(count)), position = "identity", alpha = 1, bins = 15) +
            labs(x=names(synthetic_df)[i], y="Frequency (%)")
    )
}

    
```


### Bar graph
```{r echo = FALSE, eval = FALSE}
# Bar graph for categorical variables 

for(i in 5:6){
    print(
        ggplot(synthetic_df) +
            geom_bar(aes(x = synthetic_df[,i], y = stat(count) / sum(count)), position = "identity", alpha = 1) +
            labs(x=names(synthetic_df)[i], y="Frequency (%)")
    )
}

```

### Scatter plot
```{r echo = FALSE, eval = FALSE}
# scatter plot for combinations of variables

# nunerical variables
for(i in 1:3){
    for(j in (i+1):4){
          print(
                ggplot(synthetic_df) +
                    geom_point(aes(x = synthetic_df[,i], y = synthetic_df[,j])) +
                    labs(x=names(synthetic_df)[i], y=names(synthetic_df)[j])
                )
    }
}

# categorical variables
for(i in 1:2){
    for(j in 1:4){
          print(
                ggplot(synthetic_df) +
                    geom_point(aes(x = synthetic_df[,i+4], y = synthetic_df[,j])) +
                    labs(x=names(synthetic_df)[i+4], y=names(synthetic_df)[j])
                )
    }
}

```

### Box plot
```{r echo = FALSE, eval = FALSE}
# box plot for categorical variables vs. numerical variables

for(i in 1:2){
    for(j in 1:4){
          print(
                ggplot(synthetic_df) +
                    geom_boxplot(aes(x = synthetic_df[,i+4], y = synthetic_df[,j])) +
                    labs(x=names(synthetic_df)[i+4], y=names(synthetic_df)[j])
                )
    }
}


```


### Violin plot
```{r echo = FALSE, eval = FALSE}

# Violin plot: alternative of box plot
for(i in 1:2){
    for(j in 1:4){
          print(
                ggplot(synthetic_df, aes(x = synthetic_df[,i+4], y = synthetic_df[,j])) +
                    geom_violin(trim = TRUE) +
                    geom_boxplot(width=0.1)+ 
                    labs(x=names(synthetic_df)[i+4], y=names(synthetic_df)[j])
                )
    }
}

```


## function: graph_generator(df, vars, graph_type)
### input:\
* `df` : A dataframe
* `vars` : Names of Variables that used to generate graph. A string or a vector that contains strings.
* `graph_type` : The visualization type, including `"histogram"`, `"bar"`, `"scatter"`, `"boxplot"`, and `"violin"`.

### output:\
* A visualization.
```{r}

graph_generator <- function(df, vars, graph_type){
  
  if( graph_type == "histogram" ){
    # histograms for 4 numerical variables
    plot <- ggplot(df) +
      geom_histogram(aes(x = get(vars), y = stat(count) / sum(count)), position = "identity", alpha = 1, bins = 15) +
      labs(x=vars, y="Frequency (%)")
  }
  
  if( graph_type == "bar" ){
    # Bar graph for categorical variables 
    plot <- ggplot(df) + 
      geom_bar(aes(x = get(vars), y = stat(count) / sum(count)), position = "identity", alpha = 1) +
      labs(x=vars, y="Frequency (%)")
  }

  if( graph_type == "scatter" ){
    # scatter plot for combinations of variables
    plot <- ggplot(df) + 
      geom_point(aes(x = get(vars[1]), y = get(vars[2]))) +
      labs(x=vars[1], y=vars[2])
  }

  if( graph_type == "boxplot" ){
    # box plot for categorical variables vs. numerical variables
    plot <- ggplot(df) +
      geom_boxplot(aes(x = get(vars[1]), y = get(vars[2]))) +
      labs(x=vars[1], y=vars[2])
  }
  
  if( graph_type == "violin" ){
    # Violin plot: alternative of box plot
    plot <- ggplot(df, aes(x = get(vars[1]), y = get(vars[2]))) +
      geom_violin(trim = TRUE) +
      geom_boxplot(width=0.1)+ 
      labs(x=vars[1], y=vars[2])
  }
  
  return(plot)
}

```


```{r echo = FALSE, eval = FALSE}
graph_generator(synthetic_df, "N1", "histogram")
graph_generator(synthetic_df, "C1", "bar")
graph_generator(synthetic_df, c("N3", "N4"), "scatter")
graph_generator(synthetic_df, c("C2", "N4"), "boxplot")
graph_generator(synthetic_df, c("C2", "N4"), "violin")


```

### Display all visualizations
```{r echo = FALSE, eval = FALSE}

vars <- names(synthetic_df)
comb_N_N <- expand.grid(vars[1:4], vars[1:4])
comb_N_N <- as.matrix( comb_N_N[comb_N_N$Var1 != comb_N_N$Var2, ] )

comb_C_N <- as.matrix( expand.grid(vars[5:6], vars[1:4]) )
# comb_all <- as.matrix( expand.grid(vars, vars) )

for(i in vars[1:4]){
  print(graph_generator(synthetic_df, i, "histogram"))
}

for(i in vars[5:6]){
  print(graph_generator(synthetic_df, i, "bar"))
}

for(i in split(comb_N_N, row(comb_N_N))){
  print(graph_generator(synthetic_df, i, "scatter"))
}

for(i in split(comb_C_N, row(comb_C_N))){
  print(graph_generator(synthetic_df, i, "scatter"))
}

for(i in split(comb_C_N, row(comb_C_N))){
  print(graph_generator(synthetic_df, i, "boxplot"))
}

for(i in split(comb_C_N, row(comb_C_N))){
  print(graph_generator(synthetic_df, i, "violin"))
}



```

# 3. Auto graph generator

Detect the variable types, create the combination for all variables, and display all visualizations.
```{r echo = FALSE, eval = FALSE}

# find variable types
vartype <- sapply(synthetic_df, class)

varnames_N <- names(vartype[ (vartype == "numeric") | (vartype == "integer")])
varnames_C <- names(vartype[ (vartype == "character") | (vartype == "factor") | (vartype == "logical")])

# visualization all combinations
# vars <- names(synthetic_df)

comb_N_N <- expand.grid(varnames_N, varnames_N)
comb_N_N <- as.matrix( comb_N_N[comb_N_N$Var1 != comb_N_N$Var2, ] )

comb_C_N <- as.matrix( expand.grid(varnames_C, varnames_N) )

for(i in varnames_N){
  print(graph_generator(synthetic_df, i, "histogram"))
}

for(i in varnames_C){
  print(graph_generator(synthetic_df, i, "bar"))
}

for(i in split(comb_N_N, row(comb_N_N))){
  print(graph_generator(synthetic_df, i, "scatter"))
}

for(i in split(comb_C_N, row(comb_C_N))){
  print(graph_generator(synthetic_df, i, "scatter"))
}

for(i in split(comb_C_N, row(comb_C_N))){
  print(graph_generator(synthetic_df, i, "boxplot"))
}

for(i in split(comb_C_N, row(comb_C_N))){
  print(graph_generator(synthetic_df, i, "violin"))
}

```


## function: graph_saver(df, vars, graph_type, dfname, savepath)
### input:\
* `df` : A dataframe.
* `vars` : Names of Variables that used to generate graph. A string or a vector that contains strings.
* `graph_type` : The visualization type, including `"histogram"`, `"bar"`, `"scatter"`, `"boxplot"`, and `"violin"`.
* `dfname` : The file name of the dataframe.
* `savepath` : The path that a graph would be saved into.

### output:\
* A visualization saved into pdf.
```{r}

library(ggplot2)
library(dplyr)


graph_saver <- function(df, vars, graph_type, dfname, savepath){ #prefix
  
  if( graph_type == "histogram" & length(vars) == 1){
    # histograms for 4 numerical variables
    plot <- ggplot(df) +
      geom_histogram(aes(x = get(vars), y = stat(count) / sum(count) *100), 
                     bins = 15,
                     col="white") +
      labs(x=vars, y="Frequency (%)")
  } else if( graph_type == "histogram" ) {
    # stacked histograms
    plot <- ggplot(df) +
      geom_histogram(aes(get(vars[2]), y = stat(count) / sum(count) *100, fill = get(vars[1])), 
                     bins = 15,
                     col="white") +
      labs(x=vars[2], y="Frequency (%)") +
      scale_fill_discrete(name = vars[1])
  }
  

  if( graph_type == "density" & length(vars) == 1){
    # density plot for 4 numerical variables
    plot <- ggplot(df) +
      geom_density(aes(x = get(vars)), adjust = 1/4) +
      labs(x=vars, y="Density")
  } else if( graph_type == "density" ) {
    # density plot
    plot <- ggplot(df) +
      geom_density(aes(get(vars[2]), colour = get(vars[1])), adjust = 1/4) +
      labs(x=vars[2], y="Density") +
      scale_colour_discrete(name = vars[1])
  }

  if( graph_type == "freqpoly" & length(vars) == 1){
    # freqpoly for 4 numerical variables
    plot <- ggplot(df) +
      geom_freqpoly(aes(x = get(vars), y=after_stat(density) *100), bins = 15) +
      labs(x=vars, y="Frequency (%)")
  } else if( graph_type == "freqpoly" ) {
    # freqpoly
    plot <- ggplot(df) +
      geom_freqpoly(aes(x = get(vars[2]), y=after_stat(density) *100, 
                        colour = get(vars[1])), bins = 15) +
      labs(x=vars[2], y="Frequency (%)") +
      scale_colour_discrete(name = vars[1])
  }
    
  if( graph_type == "bar" & length(vars) == 1){
    # Bar graph for categorical variables 
    plot <- ggplot(df) + 
      geom_bar(aes(x = get(vars), y = stat(count) / sum(count) *100), position = "identity") +
      labs(x=vars, y="Frequency (%)")
  } else if (graph_type == "bar") {
    # stacked bar chart
    plot <- df %>% 
      count(!! rlang::sym(vars[1]), !! rlang::sym(vars[2]), .drop=FALSE) %>% 
      mutate(freq = (n / sum(n) *100)) %>%
      ggplot() + 
      geom_bar(aes(x=get(vars[1]), y=freq, fill=get(vars[2])), 
               stat="identity", position="stack"
               ) +
      labs(x=vars[1], y="Frequency (%)") +
      scale_fill_discrete(name = vars[2])
    
    # plot <- ggplot(df %>% count(get(vars[1]), get(vars[2])) %>%
    #                  mutate(pct=n/sum(n)),               
    #               # ypos = cumsum(n) - 0.5*n),  # Calculate label positions
    #               aes(get(vars[2]), n, fill=get(vars[1]))) +
    #         geom_bar(stat="identity", position="stack") +
    #   labs(x=vars[2], y="Frequency (%)") +
    #   scale_colour_discrete(name = vars[1])

    # Compute the position of labels

  #   plot <- ggplot(df) + 
  #     geom_bar(aes(x=, y=, fill=get(vars[1])), 
  #              position="stack", stat="identity") + 
  #     labs(x=vars[2], y="Frequency (%)") +
  #     scale_colour_discrete(name = vars[1])
  }

  if( graph_type == "pie" ){
    # Pie chart for categorical variables 
    
    # Create Data
    data <- data.frame(prop.table(table(df[vars])))
    names(data) <- c("group", "prop")
    data$prop <- data$prop *100
    
    # Compute the position of labels
    data$ypos <- cumsum(data$prop)- 0.5* data$prop
    
    # Basic piechart
    plot <- ggplot(data, aes(x="", y=prop, fill=group)) +
      geom_bar(stat="identity", width=1, color="white") +
      coord_polar("y", start=0) +
      theme_void() + 
      
      geom_text(aes(y = ypos, label = group), color = "white", size=6) +
      scale_fill_brewer(palette="Set1") +
      ggtitle(vars)+
      theme(plot.title = element_text(hjust = 0.5),
            legend.position="none")
  }  
  
  if( graph_type == "scatter" ){
    # scatter plot for combinations of numerical variables
    plot <- ggplot(df) + 
      geom_point(aes(x = get(vars[1]), y = get(vars[2]))) +
      labs(x=vars[1], y=vars[2])
  }
  
  if( graph_type == "heatmap" ){
    # heatmap for combinations of categorical variables
    # Heatmap 
    plot <- df %>% 
      count(!! rlang::sym(vars[1]), !! rlang::sym(vars[2]), .drop=FALSE) %>% 
      mutate(freq = (n / sum(n) *100)) %>%
      ggplot() + 
        geom_tile(aes(x=get(vars[1]), y=get(vars[2]), fill=freq)) +
        labs(x=vars[1], y=vars[2]) +
        scale_fill_binned(name = "Frequency (%)", 
                          low = "#79B3FF",
                          high = "#002C65")
  }

  if( graph_type == "boxplot" & length(vars) == 2){
    # box plot for categorical variables vs. numerical variables
    plot <- ggplot(df) +
      geom_boxplot(aes(x = get(vars[1]), y = get(vars[2]))) +
      labs(x=vars[1], y=vars[2])
  } else if (graph_type == "boxplot"){
    # box plot for numerical variables
    plot <- ggplot(df) +
      geom_boxplot(aes(x=get(vars), y="")) +
      labs(x=vars, y="")
  }
  
  if( graph_type == "violin" & length(vars) == 2){
    # Violin plot: alternative of box plot
    plot <- ggplot(df, aes(x = get(vars[1]), y = get(vars[2]))) +
      geom_violin(trim = TRUE) +
      geom_boxplot(width=0.1)+ 
      labs(x=vars[1], y=vars[2])
  } else if (graph_type == "violin"){
    # Violin plot for numerical variables
    plot <- ggplot(df, aes(x=get(vars), y="")) +
      geom_violin(trim = TRUE) +
      geom_boxplot(width=0.1) +
      labs(x=vars, y="Frequency")
  }
  
  
  ggsave(filename=paste0(dfname, "-", graph_type, "-", paste(vars, collapse=","), ".pdf"), plot=plot, path=savepath)

  # return(plot)
}



```


## function: comb_variables(df, type)
### input:\
* `df` : A dataframe.
* `type` : Combination type of variable. A string. `"N_NA"`, `C_NA`, `N_N`, `C_C`, `C_N`.

### output:\
* A vector or a matrix of variable combinations.

```{r}
comb_variables <- function(df, type){
  # determine variable types ---------------------------
  vartype <- sapply(df, class)
  
  varnames_N <- names(vartype[ (vartype == "numeric") | (vartype == "integer")])
  varnames_C <- names(vartype[ (vartype == "character") | (vartype == "factor") | (vartype == "logical")])
  
  # combinations of variables as input of graph_generator function ----------
  if (type == "N_NA"){
    return(varnames_N)
    
  } else if (type == "C_NA"){
    return(varnames_C)
    
  } else if (type == "N_N"){
    comb_N_N <- expand.grid(varnames_N, varnames_N)
    comb_N_N <- as.matrix( comb_N_N[comb_N_N$Var1 != comb_N_N$Var2, ] )
    colnames(comb_N_N) <- c("X1", "X2")
    return(comb_N_N)
    
  } else if (type == "C_C"){
    comb_C_C <- expand.grid(varnames_C, varnames_C)
    comb_C_C <- as.matrix( comb_C_C[comb_C_C$Var1 != comb_C_C$Var2, ] )
    colnames(comb_C_C) <- c("X1", "X2")
    return(comb_C_C)
    
  } else if (type == "C_N"){
    comb_C_N <- as.matrix( expand.grid(varnames_C, varnames_N) )
    colnames(comb_C_N) <- c("X1", "X2")
    return(comb_C_N)
    
  }
  
}

```

## function: auto_graphs_generator(fp)
### input:\
* `fp` : file path of the dataframe.csv

### output:\
* Save graphs into pdfs

```{r}
auto_graphs_generator <- function(fp){
  
  # create folders ---------------------------
  filename <- gsub("\\..*", "", basename(fp))
  dir0 <- paste0("Graphs-", filename)
  
  dir.create(file.path(dir0))
  dir.create(file.path(dir0, "histogram"))
  dir.create(file.path(dir0, "density"))
  dir.create(file.path(dir0, "freqpoly"))
  dir.create(file.path(dir0, "bar"))
  dir.create(file.path(dir0, "pie"))  
  dir.create(file.path(dir0, "scatter"))
  dir.create(file.path(dir0, "heatmap"))
  dir.create(file.path(dir0, "boxplot"))
  dir.create(file.path(dir0, "violin"))
  
  df_input <- read_csvy(fp, stringsAsFactors = T)
  
  # determine variable types ---------------------------
  varnames_N <- comb_variables(df_input, "N_NA")
  varnames_C <- comb_variables(df_input, "C_NA")
  comb_N_N <- comb_variables(df_input, "N_N")
  comb_C_C <- comb_variables(df_input, "C_C")
  comb_C_N <- comb_variables(df_input, "C_N")
  
  # Generate and save graphs ---------------------------
  # prefix: sprintf("%02d", 1:length(varnames_N))
  
  # N_NA ------
  mapply(graph_saver, list(df_input), varnames_N, list("histogram"), list(filename), list(file.path(dir0, "histogram"))) 
  
  mapply(graph_saver, list(df_input), varnames_N, list("density"), list(filename), list(file.path(dir0, "density")))   

  mapply(graph_saver, list(df_input), varnames_N, list("freqpoly"), list(filename), list(file.path(dir0, "freqpoly")))
  
  mapply(graph_saver, list(df_input), varnames_N, list("boxplot"), list(filename), list(file.path(dir0, "boxplot")))

  mapply(graph_saver, list(df_input), varnames_N, list("violin"), list(filename), list(file.path(dir0, "violin")))
  
  # C_NA ------
  mapply(graph_saver, list(df_input), varnames_C, list("bar"), list(filename), list(file.path(dir0, "bar")))
  
  mapply(graph_saver, list(df_input), varnames_C, list("pie"), list(filename), list(file.path(dir0, "pie")))
  
  # N_N ------
  mapply(graph_saver, list(df_input), split(comb_N_N, row(comb_N_N)), list("scatter"), list(filename), list(file.path(dir0, "scatter")))

  # C_C ------
  mapply(graph_saver, list(df_input), split(comb_C_C, row(comb_C_C)), list("heatmap"), list(filename), list(file.path(dir0, "heatmap")))
  
  mapply(graph_saver, list(df_input), split(comb_C_C, row(comb_C_C)), list("bar"), list(filename), list(file.path(dir0, "bar")))
  
  # C_N ------
  # mapply(graph_saver, list(df_input), split(comb_C_N, row(comb_C_N)), list("scatter"), list(filename), list(file.path(dir0, "scatter")))
  
  mapply(graph_saver, list(df_input), split(comb_C_N, row(comb_C_N)), list("boxplot"), list(filename), list(file.path(dir0, "boxplot")))
  
  mapply(graph_saver, list(df_input), split(comb_C_N, row(comb_C_N)), list("violin"), list(filename), list(file.path(dir0, "violin")))
  
  mapply(graph_saver, list(df_input), split(comb_C_N, row(comb_C_N)), list("histogram"), list(filename), list(file.path(dir0, "histogram"))) 

  mapply(graph_saver, list(df_input), split(comb_C_N, row(comb_C_N)), list("density"), list(filename), list(file.path(dir0, "density")))   

  mapply(graph_saver, list(df_input), split(comb_C_N, row(comb_C_N)), list("freqpoly"), list(filename), list(file.path(dir0, "freqpoly")))


}
```

```{r}
path <- file.path(getwd(), "synthetic_df.csv")
auto_graphs_generator(path)
```

## function: Questions_generator(fp)
### input:\
* `fp` : file path of the dataframe.csv

### output:\
* Save questions into .csv file

```{r}

library(dplyr)

Questions_generator <- function(fp) {
  
  # read graph files -----------------------------------
  filename <- gsub("\\..*", "", basename(fp))
  dir0 <- paste0("Graphs-", filename)
  
  # if the directory of graphs doesn't exist, create it
  if(!dir.exists(file.path(dir0))){
    auto_graphs_generator(path)
  }
  
  paths <- list.files(path = file.path(dir0), all.files = T, full.names = T, recursive = T)
  
  # read variables from the graph files ---------------------------
  list_graph_V1_V2 <- lapply( strsplit(paths, c("-|\\,|\\.")), function(x) x[ 3 : (length(x)-1)])
  
  ml <- max(lengths(list_graph_V1_V2))
  df_graph_X1_X2 <- data.frame( do.call(rbind, lapply(list_graph_V1_V2, function(x) `length<-`(unlist(x), ml))))
  
  df_graph_X1_X2$path <- paths
  names(df_graph_X1_X2) <- c("graph_type", "X1", "X2", "path")
  df_graph_X1_X2 <- df_graph_X1_X2[, c("path", "graph_type", "X1", "X2")]
  
  
  # determine variable types ---------------------------
  df_input <- read_csvy(fp, stringsAsFactors = T)

  varnames_N <- comb_variables(df_input, "N_NA")
  comb_N_NA <- data.frame(X1=varnames_N, X2=rep(NA, length(varnames_N)))
  varnames_C <- comb_variables(df_input, "C_NA")
  comb_C_NA <- data.frame(X1=varnames_C, X2=rep(NA, length(varnames_C)))
  comb_N_N <- comb_variables(df_input, "N_N")
  comb_C_C <- comb_variables(df_input, "C_C")
  comb_C_N <- comb_variables(df_input, "C_N")
  
  
  # varnames_N -------------------------------------------------
  # NA ---------------------------------------------------------
  # "histogram"
  # "boxplot"
  # "violin"
  # "density"
  # "freqpoly"
  
  Q_N_NA <- c(
    'sprintf("What is the range of %s?", df_sub_Q$X1)',
    'sprintf("What is the standard deviation of %s?", df_sub_Q$X1)',
    'sprintf("What is the mean of %s?", df_sub_Q$X1)',
    'sprintf("What is the median of %s?", df_sub_Q$X1)',
    'sprintf("What is the maximum of %s?", df_sub_Q$X1)',
    'sprintf("What is the minimum of %s?", df_sub_Q$X1)',
    'sprintf("Which interval has the highest frequency in %s?", df_sub_Q$X1)'
  )
  
  df_Q_N_NA <- data.frame()

  for(q in Q_N_NA){
    df_sub_Q <- comb_N_NA
    df_sub_Q$Questions <- eval(parse(text=q))
    df_Q_N_NA <- rbind(df_Q_N_NA, df_sub_Q)
  }
  
  # varnames_C -------------------------------------------------
  # NA ---------------------------------------------------------
  # "bar"
  # "pie"
  
  list_levels <- sapply(df_input[, varnames_C], levels)
  
  df_level <- data.frame(unlist(list_levels, use.names=F))
  df_level$X1 <- rep(names(list_levels), lengths(list_levels))
  names(df_level)[1] <- "level"
  
  df_sub <- merge(comb_C_NA, df_level, by=c("X1"), all.x=TRUE)
  
  df_l1l2 <- df_level %>%
    group_by(X1) %>%
    group_map(~t(combn(.x$level, 2))) %>%
    setNames(unique(sort(df_level$X1)))
  
  level_listmat <- lapply(seq_along(df_l1l2), 
                          function(i) {
                              d <- data.frame( cbind( names(df_l1l2)[[i]], df_l1l2[[i]] ))
                              names(d) <- c("X1", "l1", "l2")
                              
                              m <- merge(df_sub, d, by=c("X1"))
                              
                              return(m)
                            }
                          )
  
  df_sub <- bind_rows(level_listmat)
  
  Q_C_NA <- c(
    # Y (Percentage) of 1 level
    'sprintf("What is the percentage of %s in %s?", df_sub_Q$level, df_sub_Q$X1)',
  
    # Y (Percentage): Diff of 2 levels
    'sprintf("What is the difference between the percentage of %s and the percetage of %s in %s?", df_sub_Q$l1, df_sub_Q$l2, df_sub_Q$X1)',
  
    # Y (Percentage): Sum of 2 levels
    'sprintf("What percentage is %s and %s in %s taken together?", df_sub_Q$l1, df_sub_Q$l2, df_sub_Q$X1)',
  
    # X (Level): max
    'sprintf("Which group has the largest proportion in %s?", df_sub_Q$X1)',
    # X (Level): min
    'sprintf("Which group has the smallest proportion in %s?", df_sub_Q$X1)',
  
    # X (Level): Compare larger
    'sprintf("Which one has a larger proportion in %s, %s or %s?", df_sub_Q$X1, df_sub_Q$l1, df_sub_Q$l2)',
    # X (Level): Compare smaller
    'sprintf("Which one has a smaller proportion in %s, %s or %s?", df_sub_Q$X1, df_sub_Q$l1, df_sub_Q$l2)',
  
    # X (Count): Compare larger
    'sprintf("How many groups in %s has a larger proportion than %s?", df_sub_Q$X1, df_sub_Q$level)',
    # X (Count): Compare smaller
    'sprintf("How many groups in %s has a smaller proportion than %s?", df_sub_Q$X1, df_sub_Q$level)',
  
    # (Bool): Compare higher
    'sprintf("The percentage of %s is higher than that of %s in %s.", df_sub_Q$l1, df_sub_Q$l1, df_sub_Q$X1)',
    # (Bool): Compare lower
    'sprintf("The percentage of %s is lower than that of %s in %s.", df_sub_Q$l1, df_sub_Q$l2, df_sub_Q$X1)'
  )
  
  df_Q_C_NA <- data.frame()
  
  for(q in Q_C_NA){
    df_sub_Q <- df_sub
    df_sub_Q$Questions <- eval(parse(text=q))
    df_Q_C_NA <- rbind(df_Q_C_NA, df_sub_Q)
  }
  df_Q_C_NA <- df_Q_C_NA[, c("X1", "X2", "Questions")]
  df_Q_C_NA <- df_Q_C_NA[!duplicated(df_Q_C_NA), ]
  
  # varnames_N -------------------------------------------------
  # varnames_N -------------------------------------------------
  # "scatter"

  
  values_df <- data.frame(round(apply(df_input[,varnames_N], 2, median) + apply(df_input[,varnames_N], 2, sd)))
  
  values_df <- cbind(rownames(values_df), values_df)
  rownames(values_df) <- NULL
  
  names(values_df) <- c("X1", "value")
  
  df_sub <- merge(comb_N_N, values_df, by=("X1"), all.x=T)
  

  Q_N_N <- c(
    'sprintf("What is the best prediction of %s if %s is %d?", df_sub_Q$X2, df_sub_Q$X1, df_sub_Q$value)',
    'sprintf("What is the correlation between %s and %s?", df_sub_Q$X1, df_sub_Q$X2)',
    'sprintf("There is zero correlation between %s and %s.", df_sub_Q$X1, df_sub_Q$X2)',
    'sprintf("What is the approximate correlation coefficient between %s and %s.", df_sub_Q$X1, df_sub_Q$X2)',

    'sprintf("Does %s increase while %s increases?", df_sub_Q$X2, df_sub_Q$X1)',
    'sprintf("Does %s decrease while %s decreases?", df_sub_Q$X2, df_sub_Q$X1)',

    'sprintf("What is the range of %s?", df_sub_Q$X1)',
    'sprintf("What is the standard deviation of %s?", df_sub_Q$X1)',
    'sprintf("What is the mean of %s?", df_sub_Q$X1)',
    'sprintf("What is the median of %s?", df_sub_Q$X1)',
    'sprintf("What is the maximum of %s?", df_sub_Q$X1)',
    'sprintf("What is the minimum of %s?", df_sub_Q$X1)',

    'sprintf("What is the range of %s?", df_sub_Q$X2)',
    'sprintf("What is the standard deviation of %s?", df_sub_Q$X2)',
    'sprintf("What is the mean of %s?", df_sub_Q$X2)',
    'sprintf("What is the median of %s?", df_sub_Q$X2)',
    'sprintf("What is the maximum of %s?", df_sub_Q$X2)',
    'sprintf("What is the minimum of %s?", df_sub_Q$X2)'   
  )

  df_Q_N_N <- data.frame()
  
  for(q in Q_N_N){
    df_sub_Q <- df_sub
    df_sub_Q$Questions <- eval(parse(text=q))
    df_Q_N_N <- rbind(df_Q_N_N, df_sub_Q)
  }
  df_Q_N_N <- df_Q_N_N[, c("X1", "X2", "Questions")]
  df_Q_N_N <- df_Q_N_N[!duplicated(df_Q_N_N),]

  # varnames_C -------------------------------------------------
  # varnames_N -------------------------------------------------
  # "boxplot"
  # "violin"
  # "stacked histogram"
  # "density"
  # "freqpoly"
  
  df_sub <- merge(comb_C_N, df_level, by=c("X1"), all.x=TRUE)
  
  level_listmat <- lapply(seq_along(df_l1l2), 
                          function(i) {
                              d <- data.frame( cbind( names(df_l1l2)[[i]], df_l1l2[[i]] ))
                              names(d) <- c("X1", "l1", "l2")
                              
                              m <- merge(df_sub, d, by=c("X1"))
                              
                              return(m)
                            }
                          )
  
  df_sub <- bind_rows(level_listmat)
  
  Q_C_N <- c(
    'sprintf("What is the range of %s in %s of %s?", df_sub_Q$X2, df_sub_Q$level,  df_sub_Q$X1)',
    'sprintf("What is the standard deviation of %s in %s of %s?", df_sub_Q$X2, df_sub_Q$level,  df_sub_Q$X1)',
    'sprintf("What is the mean of %s in %s of %s?", df_sub_Q$X2, df_sub_Q$level,  df_sub_Q$X1)',
    'sprintf("What is the median of %s in %s of %s?", df_sub_Q$X2, df_sub_Q$level,  df_sub_Q$X1)',
    'sprintf("What is the maximum of %s in %s of %s?", df_sub_Q$X2, df_sub_Q$level,  df_sub_Q$X1)',
    'sprintf("What is the minimum of %s in %s of %s?", df_sub_Q$X2, df_sub_Q$level,  df_sub_Q$X1)',
    
    'sprintf("Which group in %s has the largest range of %s?", df_sub_Q$X1, df_sub_Q$X2)',
    'sprintf("Which group in %s has the largest standard deviation of %s?", df_sub_Q$X1, df_sub_Q$X2)',
    'sprintf("Which group in %s has the largest mean of %s?", df_sub_Q$X1, df_sub_Q$X2)',
    'sprintf("Which group in %s has the largest median of %s?", df_sub_Q$X1, df_sub_Q$X2)',
    'sprintf("Which group in %s has the largest maximum of %s?", df_sub_Q$X1, df_sub_Q$X2)',
    'sprintf("Which group in %s has the largest minimum of %s?", df_sub_Q$X1, df_sub_Q$X2)',
    
    'sprintf("Which group in %s has the smallest range of %s?", df_sub_Q$X1, df_sub_Q$X2)',
    'sprintf("Which group in %s has the smallest standard deviation of %s?", df_sub_Q$X1, df_sub_Q$X2)',
    'sprintf("Which group in %s has the smallest mean of %s?", df_sub_Q$X1, df_sub_Q$X2)',
    'sprintf("Which group in %s has the smallest median of %s?", df_sub_Q$X1, df_sub_Q$X2)',
    'sprintf("Which group in %s has the smallest maximum of %s?", df_sub_Q$X1, df_sub_Q$X2)',
    'sprintf("Which group in %s has the smallest minimum of %s?", df_sub_Q$X1, df_sub_Q$X2)',
    
    
    'sprintf("How many groups in %s is the median of %s larger than %s?", df_sub_Q$X1, df_sub_Q$X2, df_sub_Q$level)',
    'sprintf("How many groups in %s is the median of %s smaller than %s?", df_sub_Q$X1, df_sub_Q$X2, df_sub_Q$level)',
    
    'sprintf("Which group in %s has a larger range of %s, %s or %s?", df_sub_Q$X1, df_sub_Q$X2, df_sub_Q$l1, df_sub_Q$l2)',
    'sprintf("Which group in %s has a larger standard deviation of %s, %s or %s?", df_sub_Q$X1, df_sub_Q$X2, df_sub_Q$l1, df_sub_Q$l2)',
    'sprintf("Which group in %s has a larger mean of %s, %s or %s?", df_sub_Q$X2, df_sub_Q$X2, df_sub_Q$l1, df_sub_Q$l2)',
    'sprintf("Which group in %s has a larger median of %s, %s or %s?", df_sub_Q$X2, df_sub_Q$X2, df_sub_Q$l1, df_sub_Q$l2)',  
    'sprintf("Which group in %s has a larger maximum of %s, %s or %s?", df_sub_Q$X2, df_sub_Q$X2, df_sub_Q$l1, df_sub_Q$l2)',
    'sprintf("Which group in %s has a larger minimum of %s, %s or %s?", df_sub_Q$X1, df_sub_Q$X2, df_sub_Q$l1, df_sub_Q$l2)',  
    
    'sprintf("Which group in %s has a smaller range of %s, %s or %s?", df_sub_Q$X1, df_sub_Q$X2, df_sub_Q$l1, df_sub_Q$l2)',
    'sprintf("Which group in %s has a smaller standard deviation of %s, %s or %s?", df_sub_Q$X1, df_sub_Q$X2, df_sub_Q$l1, df_sub_Q$l2)',
    'sprintf("Which group in %s has a smaller mean of %s, %s or %s?", df_sub_Q$X1, df_sub_Q$X2, df_sub_Q$l1, df_sub_Q$l2)',
    'sprintf("Which group in %s has a smaller median of %s, %s or %s?", df_sub_Q$X1, df_sub_Q$X2, df_sub_Q$l1, df_sub_Q$l2)',  
    'sprintf("Which group in %s has a smaller maximum of %s, %s or %s?", df_sub_Q$X1, df_sub_Q$X2, df_sub_Q$l1, df_sub_Q$l2)',
    'sprintf("Which group in %s has a smaller minimum of %s, %s or %s?", df_sub_Q$X1, df_sub_Q$X2, df_sub_Q$l1, df_sub_Q$l2)'
  )
  
  df_Q_C_N <- data.frame()
  
  for(q in Q_C_N){
    df_sub_Q <- df_sub
    df_sub_Q$Questions <- eval(parse(text=q))
    df_Q_C_N <- rbind(df_Q_C_N, df_sub_Q)
  }
  df_Q_C_N <- df_Q_C_N[, c("X1", "X2", "Questions")]
  df_Q_C_N <- df_Q_C_N[!duplicated(df_Q_C_N),]
  
  # merge all types of variables combinations
  questions_df <- rbind(
    merge(df_graph_X1_X2, df_Q_N_NA, by=c("X1", "X2"), all.y = T), 
    merge(df_graph_X1_X2, df_Q_C_NA, by=c("X1", "X2"), all.y = T),
    merge(df_graph_X1_X2, df_Q_N_N, by=c("X1", "X2"), all.y = T),
    merge(df_graph_X1_X2, df_Q_C_N, by=c("X1", "X2"), all.y = T)
  )
  
  write.csv(questions_df, file.path(getwd(), paste0("Questions-", filename, ".csv")))
}

```



```{r}
path <- file.path(getwd(), "synthetic_df.csv")

Questions_generator(path)

```