---
title: "Graph generator"
author: "Man-fang Liang"
date: "4/11/2022"
output:
  html_document: default
---
```{r}
install.packages("csvy")
library(csvy)

```

# 1. Create synthetic dataset

## Generate numerical variables
```{r}
# numerical variables ------------------------------------------------

# generate variables -------

# generate random mean and sd
# set.seed(1)
mean_vector <- runif(4, min=0, max=100)
# set.seed(2)
sd_vector <- runif(4, min=0, max=100)

rowsize <- 100

# N1 & N2 (independent)
# set.seed(3)
N1 <- rnorm(rowsize, mean=mean_vector[1], sd=sd_vector[1])
# set.seed(4)
N2 <- rnorm(rowsize, mean=mean_vector[2], sd=sd_vector[2])

# N3 & N4 (correlated)
# set.seed(5)
N3 <- rnorm(rowsize, mean=mean_vector[3], sd=sd_vector[3])
# set.seed(6)
N4 <- rnorm(rowsize, mean=mean_vector[4], sd=sd_vector[4])

# make N3 & N4 correlated
N3 <- sort(N3)
N4 <- sort(N4)

# reorder N3 & N4 at the same time
# set.seed(7)
random_order <- sample(1:rowsize, rowsize, replace=F)
N3 <- N3[random_order]
N4 <- N4[random_order]

# add noise to N4
# set.seed(8)
N4 <- N4 + rnorm(rowsize, mean=0, sd=sd_vector[4] * 0.3)


```

## Generate categorical variables
```{r}
# categorical variables ------------------------------------------------

# C1: nominal w/2 values
C1_values <- c('A', 'B')

C1_values_sample <- rep(C1_values, rowsize / length(C1_values))
# set.seed(9)
C1 <- sample(C1_values_sample, rowsize, replace = F)

## Another way of sampling
# C1 <- sample(C1_values, rowsize, replace = T)

# C2: ordernal  w/3 levels, N4 predictive
C2_values <- c('low', 'medium', 'high')

# make N4 predictive of C2
N4_quantile <- quantile(N4, c(0.35, 0.65))
C2 <- ifelse( N4 < N4_quantile[1], C2_values[1], ifelse( N4 < N4_quantile[2], C2_values[2], C2_values[3] ))

# add noise
C2_noise_size <- as.integer(rowsize * 0.3)
# set.seed(10)
C2_noise_index <- sample(1:rowsize, C2_noise_size, replace = F)
# set.seed(11)
C2_noise_value <- sample(C2_values, C2_noise_size, replace = T)

C2[C2_noise_index] <- C2_noise_value

C2 <- factor(C2, levels=c('low', 'medium', 'high'))

```

## Conbine all variables into a single dataset
```{r}
synthetic_df <- data.frame(N1=N1, N2=N2, N3=N3, N4=N4, C1=C1, C2=C2)
synthetic_df

rm(list = c("N1", "N2", "N3", "N4", "C1", "C2"))

```


```{r}
setwd(".")
write_csvy(synthetic_df, file.path(getwd(), "synthetic_df.csv"), row.names = FALSE)

```


## Descriptive statistics for the synthetic dataset
```{r}
summary(synthetic_df)
table(synthetic_df$C1)
table(synthetic_df$C2)

```


# 2. Visualization (Hardcode)
```{r}
# import pacakage
# install.packages("ggplot2",repos = "http://cran.us.r-project.org")
library(ggplot2)
```


### Histogram
```{r}
# histograms for 4 numerical variables

for(i in 1:4){
    print(
        ggplot(synthetic_df) +
            geom_histogram(aes(x = synthetic_df[,i], y = stat(count) / sum(count)), position = "identity", alpha = 1, bins = 15) +
            labs(x=names(synthetic_df)[i], y="Frequency (%)")
    )
}

    
```


### Bar graph
```{r}
# Bar graph for categorical variables 

for(i in 5:6){
    print(
        ggplot(synthetic_df) +
            geom_bar(aes(x = synthetic_df[,i], y = stat(count) / sum(count)), position = "identity", alpha = 1) +
            labs(x=names(synthetic_df)[i], y="Frequency (%)")
    )
}

```

### Scatter plot
```{r}
# scatter plot for combinations of variables

# nunerical variables
for(i in 1:3){
    for(j in (i+1):4){
          print(
                ggplot(synthetic_df) +
                    geom_point(aes(x = synthetic_df[,i], y = synthetic_df[,j])) +
                    labs(x=names(synthetic_df)[i], y=names(synthetic_df)[j])
                )
    }
}

# categorical variables
for(i in 1:2){
    for(j in 1:4){
          print(
                ggplot(synthetic_df) +
                    geom_point(aes(x = synthetic_df[,i+4], y = synthetic_df[,j])) +
                    labs(x=names(synthetic_df)[i+4], y=names(synthetic_df)[j])
                )
    }
}

```

### Box plot
```{r}
# box plot for categorical variables vs. numerical variables

for(i in 1:2){
    for(j in 1:4){
          print(
                ggplot(synthetic_df) +
                    geom_boxplot(aes(x = synthetic_df[,i+4], y = synthetic_df[,j])) +
                    labs(x=names(synthetic_df)[i+4], y=names(synthetic_df)[j])
                )
    }
}


```


### Violin plot
```{r}

# Violin plot: alternative of box plot
for(i in 1:2){
    for(j in 1:4){
          print(
                ggplot(synthetic_df, aes(x = synthetic_df[,i+4], y = synthetic_df[,j])) +
                    geom_violin(trim = TRUE) +
                    geom_boxplot(width=0.1)+ 
                    labs(x=names(synthetic_df)[i+4], y=names(synthetic_df)[j])
                )
    }
}

```


## function: graph_generator(df, vars, graph_type)
### input:\
* df: A dataframe
* vars: Names of Variables that used to generate graph. A string or a vector that contains strings.
* graph_type: The visualization type, including `"histogram"`, `"bar"`, `"scatter"`, `"boxplot"`, and `"violin"`.\
### output:\
* A visualization.
```{r}

graph_generator <- function(df, vars, graph_type){
  
  if( graph_type == "histogram" ){
    # histograms for 4 numerical variables
    plot <- ggplot(df) +
      geom_histogram(aes(x = get(vars), y = stat(count) / sum(count)), position = "identity", alpha = 1, bins = 15) +
      labs(x=vars, y="Frequency (%)")
  }
  
  if( graph_type == "bar" ){
    # Bar graph for categorical variables 
    plot <- ggplot(df) + 
      geom_bar(aes(x = get(vars), y = stat(count) / sum(count)), position = "identity", alpha = 1) +
      labs(x=vars, y="Frequency (%)")
  }

  if( graph_type == "scatter" ){
    # scatter plot for combinations of variables
    plot <- ggplot(df) + 
      geom_point(aes(x = get(vars[1]), y = get(vars[2]))) +
      labs(x=vars[1], y=vars[2])
  }

  if( graph_type == "boxplot" ){
    # box plot for categorical variables vs. numerical variables
    plot <- ggplot(df) +
      geom_boxplot(aes(x = get(vars[1]), y = get(vars[2]))) +
      labs(x=vars[1], y=vars[2])
  }
  
  if( graph_type == "violin" ){
    # Violin plot: alternative of box plot
    plot <- ggplot(df, aes(x = get(vars[1]), y = get(vars[2]))) +
      geom_violin(trim = TRUE) +
      geom_boxplot(width=0.1)+ 
      labs(x=vars[1], y=vars[2])
  }
  
  return(plot)
}

```


```{r}
graph_generator(synthetic_df, "N1", "histogram")
graph_generator(synthetic_df, "C1", "bar")
graph_generator(synthetic_df, c("N3", "N4"), "scatter")
graph_generator(synthetic_df, c("C2", "N4"), "boxplot")
graph_generator(synthetic_df, c("C2", "N4"), "violin")


```

### Display all visualizations
```{r}

vars <- names(synthetic_df)
comb_N_N <- expand.grid(vars[1:4], vars[1:4])
comb_N_N <- as.matrix( comb_N_N[comb_N_N$Var1 != comb_N_N$Var2, ] )

comb_C_N <- as.matrix( expand.grid(vars[5:6], vars[1:4]) )
# comb_all <- as.matrix( expand.grid(vars, vars) )

for(i in vars[1:4]){
  print(graph_generator(synthetic_df, i, "histogram"))
}

for(i in vars[5:6]){
  print(graph_generator(synthetic_df, i, "bar"))
}

for(i in split(comb_N_N, row(comb_N_N))){
  print(graph_generator(synthetic_df, i, "scatter"))
}

for(i in split(comb_C_N, row(comb_C_N))){
  print(graph_generator(synthetic_df, i, "scatter"))
}

for(i in split(comb_C_N, row(comb_C_N))){
  print(graph_generator(synthetic_df, i, "boxplot"))
}

for(i in split(comb_C_N, row(comb_C_N))){
  print(graph_generator(synthetic_df, i, "violin"))
}



```

# 3. Auto graph generator

Detect the variable types, create the combination for all variables, and display all visualizations.
```{r}

# find variable types
vartype <- sapply(synthetic_df, class)

varnames_N <- names(vartype[ (vartype == "numeric") | (vartype == "integer")])
varnames_C <- names(vartype[ (vartype == "character") | (vartype == "factor") | (vartype == "logical")])

# visualization all combinations
# vars <- names(synthetic_df)

comb_N_N <- expand.grid(varnames_N, varnames_N)
comb_N_N <- as.matrix( comb_N_N[comb_N_N$Var1 != comb_N_N$Var2, ] )

comb_C_N <- as.matrix( expand.grid(varnames_C, varnames_N) )

for(i in varnames_N){
  print(graph_generator(synthetic_df, i, "histogram"))
}

for(i in varnames_C){
  print(graph_generator(synthetic_df, i, "bar"))
}

for(i in split(comb_N_N, row(comb_N_N))){
  print(graph_generator(synthetic_df, i, "scatter"))
}

for(i in split(comb_C_N, row(comb_C_N))){
  print(graph_generator(synthetic_df, i, "scatter"))
}

for(i in split(comb_C_N, row(comb_C_N))){
  print(graph_generator(synthetic_df, i, "boxplot"))
}

for(i in split(comb_C_N, row(comb_C_N))){
  print(graph_generator(synthetic_df, i, "violin"))
}

```


## function: graph_saver(df, vars, graph_type, dfname, savepath)
### input:\
* df: A dataframe
* vars: Names of Variables that used to generate graph. A string or a vector that contains strings.
* graph_type: The visualization type, including `"histogram"`, `"bar"`, `"scatter"`, `"boxplot"`, and `"violin"`.
* dfname: The file name of the dataframe
* savepath: The path that a graph would be saved into.\
### output:\
* A visualization saved into pdf.
```{r}

graph_saver <- function(df, vars, graph_type, dfname, savepath){ #prefix
  
  if( graph_type == "histogram" ){
    # histograms for 4 numerical variables
    plot <- ggplot(df) +
      geom_histogram(aes(x = get(vars), y = stat(count) / sum(count)), position = "identity", alpha = 1, bins = 15) +
      labs(x=vars, y="Frequency (%)")
  }
  
  if( graph_type == "bar" ){
    # Bar graph for categorical variables 
    plot <- ggplot(df) + 
      geom_bar(aes(x = get(vars), y = stat(count) / sum(count)), position = "identity", alpha = 1) +
      labs(x=vars, y="Frequency (%)")
  }

  if( graph_type == "scatter" ){
    # scatter plot for combinations of variables
    plot <- ggplot(df) + 
      geom_point(aes(x = get(vars[1]), y = get(vars[2]))) +
      labs(x=vars[1], y=vars[2])
  }

  if( graph_type == "boxplot" ){
    # box plot for categorical variables vs. numerical variables
    plot <- ggplot(df) +
      geom_boxplot(aes(x = get(vars[1]), y = get(vars[2]))) +
      labs(x=vars[1], y=vars[2])
  }
  
  if( graph_type == "violin" ){
    # Violin plot: alternative of box plot
    plot <- ggplot(df, aes(x = get(vars[1]), y = get(vars[2]))) +
      geom_violin(trim = TRUE) +
      geom_boxplot(width=0.1)+ 
      labs(x=vars[1], y=vars[2])
  }
  
  ggsave(filename=paste0(dfname, "-", graph_type, "-", paste(vars, collapse="_"), ".pdf"), plot=plot, path=savepath)

  # return(plot)
}


```


## function: auto_graphs_generator(fp)
### input:\
* fp: file path of the dataframe.csv
### output:\
* Save graphs into pdfs

```{r}
auto_graphs_generator <- function(fp){
  
  # create folders ---------------------------
  filename <- gsub("\\..*", "", basename(fp))
  dir0 <- paste0("Graphs-", filename)
  
  dir.create(file.path(dir0))
  dir.create(file.path(dir0, "histogram"))
  dir.create(file.path(dir0, "bar"))
  dir.create(file.path(dir0, "scatter"))
  dir.create(file.path(dir0, "boxplot"))
  dir.create(file.path(dir0, "violin"))
  
  df_input <- read_csvy(fp, stringsAsFactors = T)
  
  # determine variable types ---------------------------
  vartype <- sapply(df_input, class)
  
  varnames_N <- names(vartype[ (vartype == "numeric") | (vartype == "integer")])
  varnames_C <- names(vartype[ (vartype == "character") | (vartype == "factor") | (vartype == "logical")])
  
  # combinations of variables as input of graph_generator function ----------
  comb_N_N <- expand.grid(varnames_N, varnames_N)
  comb_N_N <- as.matrix( comb_N_N[comb_N_N$Var1 != comb_N_N$Var2, ] )
  
  comb_C_N <- as.matrix( expand.grid(varnames_C, varnames_N) )
  
  # Generate and save graphs ---------------------------
  # prefix: sprintf("%02d", 1:length(varnames_N))
  mapply(graph_saver, list(df_input), varnames_N, list("histogram"), list(filename), list(file.path(dir0, "histogram"))) 
  
  mapply(graph_saver, list(df_input), varnames_C, list("bar"), list(filename), list(file.path(dir0, "bar")))
  
  mapply(graph_saver, list(df_input), split(comb_N_N, row(comb_N_N)), list("scatter"), list(filename), list(file.path(dir0, "scatter")))
  
  mapply(graph_saver, list(df_input), split(comb_C_N, row(comb_C_N)), list("scatter"), list(filename), list(file.path(dir0, "scatter")))
  
  mapply(graph_saver, list(df_input), split(comb_C_N, row(comb_C_N)), list("boxplot"), list(filename), list(file.path(dir0, "boxplot")))
  
  mapply(graph_saver, list(df_input), split(comb_C_N, row(comb_C_N)), list("violin"), list(filename), list(file.path(dir0, "violin")))
}

```

```{r}
path <- file.path(getwd(), "synthetic_df.csv")
auto_graphs_generator(path)
```


